@using myapp.Services
@inject myapp.Services.ResourceService ResourceService
@inject myapp.Services.BuildingService BuildingService
@inject myapp.Services.PlayerStateService PlayerStateService
@inject myapp.Services.GalaxyService GalaxyService
@implements IDisposable

<div class="top-menu">
    <div class="resource-selector" style="margin-right: 20px;">
        <select @onchange="OnPlanetChanged" style="background: var(--color-bg-tertiary); color: white; border: 1px solid var(--color-border-medium); padding: 5px; border-radius: 4px;">
            @foreach (var planet in GalaxyService.PlayerPlanets)
            {
                <option value="@($"{planet.Galaxy}:{planet.System}:{planet.Position}")" 
                        selected="@IsSelected(planet)">
                    @planet.Name [@planet.Galaxy:@planet.System:@planet.Position]
                </option>
            }
        </select>
    </div>
    <div class="resource" title="Total Production: @BuildingService.MetalHourlyProduction.ToString("N0")/h
Energy Use: @BuildingService.MetalMineEnergyConsumption
Production Factor: @((BuildingService.ProductionFactor * 100).ToString("0"))%">
        <label>Metal</label>
        <span class="resource-value">@_snapshot.Metal.ToString("N0")</span>
    </div>
    <div class="resource" title="Total Production: @BuildingService.CrystalHourlyProduction.ToString("N0")/h
Energy Use: @BuildingService.CrystalMineEnergyConsumption
Production Factor: @((BuildingService.ProductionFactor * 100).ToString("0"))%">
        <label>Crystal</label>
        <span class="resource-value">@_snapshot.Crystal.ToString("N0")</span>
    </div>
    <div class="resource" title="Total Production: @BuildingService.DeuteriumHourlyProduction.ToString("N0")/h
Energy Use: @BuildingService.DeuteriumSynthesizerEnergyConsumption
Production Factor: @((BuildingService.ProductionFactor * 100).ToString("0"))%">
        <label>Deuterium</label>
        <span class="resource-value">@_snapshot.Deuterium.ToString("N0")</span>
    </div>
    <div class="resource">
        <label>Energy</label>
        <span class="resource-value">@_snapshot.Energy.ToString("N0")</span>
    </div>
    <div class="resource">
        <label>Dark Matter</label>
        <span class="resource-value">@_snapshot.DarkMatter.ToString("N0")</span>
    </div>
</div>

@code {
    private System.Threading.Timer? _timer;
    private ResourceSnapshot _snapshot = new(0, 0, 0, 0, 0);

    protected override void OnInitialized()
    {
        // Initialize timer to tick every second
        _timer = new System.Threading.Timer(Tick, null, 0, 1000);
    }

    private async void Tick(object? state)
    {
        // Skip if planet not initialized yet
        if (PlayerStateService.ActiveGalaxy <= 0 || PlayerStateService.ActiveSystem <= 0 || PlayerStateService.ActivePosition <= 0)
        {
            return;
        }
        
        await BuildingService.UpdateProductionAsync();
        _snapshot = await ResourceService.GetResourceSnapshotAsync();
        await InvokeAsync(StateHasChanged);
    }

    private bool IsSelected(myapp.Services.GalaxyPlanet planet)
    {
        return planet.Galaxy == PlayerStateService.ActiveGalaxy && 
               planet.System == PlayerStateService.ActiveSystem && 
               planet.Position == PlayerStateService.ActivePosition;
    }

    private void OnPlanetChanged(ChangeEventArgs e)
    {
        var val = e.Value?.ToString();
        if (string.IsNullOrEmpty(val)) return;

        var parts = val.Split(':');
        if (parts.Length == 3 && 
            int.TryParse(parts[0], out int g) && 
            int.TryParse(parts[1], out int s) && 
            int.TryParse(parts[2], out int p))
        {
            PlayerStateService.SetActivePlanet(g, s, p);
        }
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }
}
