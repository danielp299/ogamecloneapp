@page "/options"
@using myapp.Services
@inject GamePersistenceService PersistenceService
@inject GameInitializationService GameInitializationService
@inject PlayerStateService PlayerStateService
@inject DevModeService DevModeService
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Options</PageTitle>

<div class="ogame-container">
    <div class="ogame-banner" style="background-image: url('assets/banners/buildings-banner.jpg');">
        <h2>Options</h2>
        <p>Game settings and data management</p>
    </div>

    <div class="ogame-grid-2">
        <!-- DevMode Toggle -->
        <div class="ogame-card">
            <h3>Developer Mode</h3>
            <p style="margin-bottom: 1rem;">
                DevMode speeds up construction and research times for testing purposes.
            </p>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <span class="ogame-badge @(DevModeService.IsEnabled ? "success" : "secondary")">
                    @(DevModeService.IsEnabled ? "ENABLED" : "DISABLED")
                </span>
                <button class="ogame-btn @(DevModeService.IsEnabled ? "btn-danger" : "btn-primary")" 
                        @onclick="ToggleDevMode">
                    @(DevModeService.IsEnabled ? "Disable" : "Enable")
                </button>
            </div>
        </div>

        <!-- Data Management -->
        <div class="ogame-card">
            <h3>Data Management</h3>
            <p style="margin-bottom: 1rem;">
                Reset all game progress. This action cannot be undone!
            </p>
            <button class="ogame-btn btn-danger" @onclick="ShowResetConfirmation">
                Reset Game Data
            </button>
        </div>
    </div>

    <!-- Game Statistics -->
    <div class="ogame-panel" style="margin-top: 2rem;">
        <h3>Game Statistics</h3>
        <div class="ogame-grid-4" style="margin-top: 1rem;">
            <div class="text-center">
                <div class="text-muted">Buildings</div>
                <strong>@buildingCount</strong>
            </div>
            <div class="text-center">
                <div class="text-muted">Technologies</div>
                <strong>@technologyCount</strong>
            </div>
            <div class="text-center">
                <div class="text-muted">Ships</div>
                <strong>@shipCount</strong>
            </div>
            <div class="text-center">
                <div class="text-muted">Defenses</div>
                <strong>@defenseCount</strong>
            </div>
        </div>
    </div>

    @if (showResetConfirmation)
    {
        <div class="ogame-modal">
            <div class="ogame-modal-content">
                <h3>Confirm Reset</h3>
                <p>Are you sure you want to reset all game data? This action cannot be undone!</p>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button class="ogame-btn btn-secondary" @onclick="HideResetConfirmation">Cancel</button>
                    <button class="ogame-btn btn-danger" @onclick="ResetGame">Reset</button>
                </div>
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="ogame-alert @(statusIsError ? "alert-danger" : "alert-success")" 
             style="margin-top: 1rem; padding: 1rem; border-radius: 4px;">
            @statusMessage
        </div>
    }
</div>

<style>
    .ogame-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .ogame-modal-content {
        background: #1a1a2e;
        padding: 2rem;
        border-radius: 8px;
        max-width: 400px;
        width: 90%;
        border: 1px solid #16213e;
    }

    .ogame-alert {
        background: #1a1a2e;
        border: 1px solid;
    }

    .alert-success {
        border-color: #28a745;
        color: #28a745;
    }

    .alert-danger {
        border-color: #dc3545;
        color: #dc3545;
    }

    .success {
        background: #28a745;
    }

    .secondary {
        background: #6c757d;
    }
</style>

@code {
    private bool showResetConfirmation = false;
    private string? statusMessage;
    private bool statusIsError = false;
    private int buildingCount;
    private int technologyCount;
    private int shipCount;
    private int defenseCount;
    private System.Threading.Timer? _refreshTimer;

    protected override void OnInitialized()
    {
        DevModeService.OnChange += RefreshState;
        LoadStatistics();
        
        // Refresh timer for statistics
        _refreshTimer = new System.Threading.Timer(_ => InvokeAsync(LoadStatistics), null, 0, 5000);
    }

    private async void RefreshState()
    {
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadStatistics()
    {
        // This will be populated once we update the services
        // For now, just trigger a re-render
        await InvokeAsync(StateHasChanged);
    }

    private async Task ToggleDevMode()
    {
        await DevModeService.ToggleAsync();
        ShowStatus($"DevMode {(DevModeService.IsEnabled ? "enabled" : "disabled")}", false);
    }

    private void ShowResetConfirmation()
    {
        showResetConfirmation = true;
    }

    private void HideResetConfirmation()
    {
        showResetConfirmation = false;
    }

    private async Task ResetGame()
    {
        try
        {
            ShowStatus("Resetting game and creating new universe...", false);
            StateHasChanged();
            
            // Use the new complete reset method
            await GameInitializationService.ResetAndReinitializeGameAsync(PlayerStateService);
            
            showResetConfirmation = false;
            ShowStatus("Game reset successfully! New universe created.", false);
            
            // Reload page after a short delay
            await Task.Delay(2000);
            Navigation.NavigateTo("/", forceLoad: true);
        }
        catch (Exception ex)
        {
            ShowStatus($"Error resetting game: {ex.Message}", true);
        }
    }

    private void ShowStatus(string message, bool isError)
    {
        statusMessage = message;
        statusIsError = isError;
        StateHasChanged();
        
        // Clear message after 5 seconds
        Task.Run(async () =>
        {
            await Task.Delay(5000);
            await InvokeAsync(() =>
            {
                statusMessage = null;
                StateHasChanged();
            });
        });
    }

    public void Dispose()
    {
        DevModeService.OnChange -= RefreshState;
        _refreshTimer?.Dispose();
    }
}
