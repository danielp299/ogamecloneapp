@page "/constellation"
@using myapp.Services
@inject GalaxyService GalaxyService
@inject NavigationManager Navigation

<PageTitle>Galaxy</PageTitle>

<div class="ogame-container">
    <!-- Banner -->
    <div class="ogame-banner" style="background-image: url('assets/banners/tech-banner.jpg');">
        <h2>Galaxy View</h2>
        <p>Explore the universe and launch missions</p>
    </div>

    <!-- Navigation Panel -->
    <div class="ogame-panel mb-lg">
        <div style="display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap;">
            <button class="ogame-btn ogame-btn-secondary" @onclick="PrevSystem">&lt; Previous</button>

            <div style="display: flex; align-items: center; gap: 15px;">
                <div>
                    <label style="font-weight: bold; margin-right: 5px;">Galaxy</label>
                    <input type="number" min="1" max="9" @bind="CurrentGalaxy"
                           style="width: 60px; padding: 5px; text-align: center; background-color: var(--color-bg-primary); color: white; border: 1px solid var(--color-border-medium); border-radius: 3px;" />
                </div>
                <div>
                    <label style="font-weight: bold; margin-right: 5px;">System</label>
                    <input type="number" min="1" max="499" @bind="CurrentSystem"
                           style="width: 60px; padding: 5px; text-align: center; background-color: var(--color-bg-primary); color: white; border: 1px solid var(--color-border-medium); border-radius: 3px;" />
                </div>
                <button class="ogame-btn ogame-btn-primary" @onclick="LoadSystem">Go</button>
            </div>

            <button class="ogame-btn ogame-btn-secondary" @onclick="NextSystem">Next &gt;</button>
        </div>
    </div>

    <!-- Galaxy Table -->
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; background-color: var(--color-bg-secondary); border-radius: 10px; overflow: hidden;">
            <thead>
                <tr style="background-color: var(--color-bg-tertiary);">
                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid var(--color-border-medium);">Pos</th>
                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid var(--color-border-medium);">Image</th>
                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid var(--color-border-medium);">Planet Name</th>
                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid var(--color-border-medium);">Player</th>
                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid var(--color-border-medium);">Alliance</th>
                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid var(--color-border-medium);">Debris</th>
                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid var(--color-border-medium);">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (CurrentPlanets != null)
                {
                    @foreach (var planet in CurrentPlanets)
                    {
                        <tr style="border-bottom: 1px solid var(--color-border-subtle); transition: background-color 0.2s;"
                            @onmouseover="@(() => {})"
                            onmouseenter="this.style.backgroundColor='var(--color-bg-tertiary)'"
                            onmouseleave="this.style.backgroundColor='transparent'">
                            <td style="padding: 10px 15px; vertical-align: middle;">
                                <strong>@planet.Position</strong>
                            </td>
                            <td style="padding: 10px 15px; vertical-align: middle;">
                                <img src="@planet.Image" alt="Planet"
                                     style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid var(--color-border-medium);" />
                            </td>
                            <td style="padding: 10px 15px; vertical-align: middle;">
                                @if (planet.IsOccupied)
                                {
                                    <span style="color: @(planet.IsMyPlanet ? "var(--color-success)" : "var(--color-danger)"); font-weight: bold;">
                                        @planet.Name
                                    </span>
                                    @if (planet.IsHomeworld)
                                    {
                                        <span class="ogame-badge ogame-badge-success" style="margin-left: 5px; font-size: 0.7em;">Home</span>
                                    }
                                }
                                else
                                {
                                    <span class="text-muted" style="font-style: italic;">Empty Space</span>
                                }
                            </td>
                            <td style="padding: 10px 15px; vertical-align: middle;">
                                @if (planet.IsOccupied)
                                {
                                    <span>@planet.PlayerName</span>
                                }
                            </td>
                            <td style="padding: 10px 15px; vertical-align: middle;">
                                @if (!string.IsNullOrEmpty(planet.Alliance))
                                {
                                    <span style="color: var(--color-accent-cyan);">@planet.Alliance</span>
                                }
                            </td>
                            <td style="padding: 10px 15px; vertical-align: middle;">
                                @if (planet.HasDebris)
                                {
                                    <div style="font-size: 0.85em;">
                                        <div style="color: var(--color-metal);">M: @planet.DebrisMetal.ToString("N0")</div>
                                        <div style="color: var(--color-crystal);">C: @planet.DebrisCrystal.ToString("N0")</div>
                                    </div>
                                }
                            </td>
                            <td style="padding: 10px 15px; vertical-align: middle;">
                                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                    @if (planet.IsOccupied && !planet.IsMyPlanet)
                                    {
                                        <button class="ogame-btn ogame-btn-danger ogame-btn-sm" @onclick="() => SendFleet(planet.Position, 1)">
                                            Attack
                                        </button>
                                        <button class="ogame-btn ogame-btn-secondary ogame-btn-sm" @onclick="() => SendFleet(planet.Position, 2)">
                                            Spy
                                        </button>
                                    }
                                    else if (!planet.IsOccupied)
                                    {
                                        <button class="ogame-btn ogame-btn-sm" style="background-color: var(--color-warning);" @onclick="() => SendFleet(planet.Position, 3)">
                                            Colonize
                                        </button>
                                    }

                                    @if (planet.HasDebris)
                                    {
                                        <button class="ogame-btn ogame-btn-sm" style="background-color: var(--color-info);" @onclick="() => SendFleet(planet.Position, 4)">
                                            Recycle
                                        </button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    private int CurrentGalaxy = 1;
    private int CurrentSystem = 1;
    private List<GalaxyPlanet> CurrentPlanets;

    protected override void OnInitialized()
    {
        LoadSystem();
    }

    private void LoadSystem()
    {
        CurrentPlanets = GalaxyService.GetSystem(CurrentGalaxy, CurrentSystem);
    }

    private void PrevSystem()
    {
        if (CurrentSystem > 1)
        {
            CurrentSystem--;
            LoadSystem();
        }
    }

    private void NextSystem()
    {
        if (CurrentSystem < 499)
        {
            CurrentSystem++;
            LoadSystem();
        }
    }

    private void SendFleet(int position, int missionCode)
    {
        string mission = missionCode switch
        {
            1 => "Attack",
            2 => "Espionage",
            3 => "Colonize",
            4 => "Recycle",
            _ => "Attack"
        };

        Navigation.NavigateTo($"/fleet?galaxy={CurrentGalaxy}&system={CurrentSystem}&position={position}&mission={mission}");
    }
}
