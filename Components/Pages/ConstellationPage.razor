@page "/constellation"
@using myapp.Services
@inject GalaxyService GalaxyService
@inject NavigationManager Navigation

<style>
    .galaxy-container {
        color: white;
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
        background-color: #000000;
        border-radius: 10px;
    }

    article {
        background-color: #000000;
    }

    .nav-panel {
        background-color: #222;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        border: 1px solid #444;
    }

    .nav-panel input {
        width: 60px;
        padding: 5px;
        background-color: #333;
        color: white;
        border: 1px solid #555;
        text-align: center;
    }

    .nav-button {
        background-color: #444;
        border: none;
        color: white;
        padding: 5px 15px;
        border-radius: 3px;
        cursor: pointer;
    }

    .nav-button:hover {
        background-color: #666;
    }

    .galaxy-table {
        width: 100%;
        border-collapse: collapse;
        background-color: #1a1a1a;
        border-radius: 10px;
        overflow: hidden;
    }

    .galaxy-table th {
        background-color: #333;
        padding: 15px;
        text-align: left;
    }

    .galaxy-table td {
        padding: 10px 15px;
        border-bottom: 1px solid #333;
        vertical-align: middle;
    }

    .planet-row:hover {
        background-color: #2a2a2a;
    }

    .planet-img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid #555;
    }

    .status-vacant {
        color: #666;
        font-style: italic;
    }

    .status-occupied {
        color: #4CAF50;
        font-weight: bold;
    }
    
    .status-enemy {
        color: #FF5252;
        font-weight: bold;
    }

    .action-btn {
        background-color: #2196F3;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.8em;
        margin-right: 5px;
    }
    
    .debris-info {
        font-size: 0.8em;
        color: #aaa;
    }
</style>

<div class="galaxy-container">
    <div class="nav-panel">
        <button class="nav-button" @onclick="PrevSystem">&lt;</button>
        <div>
            <label>Galaxy</label>
            <input type="number" min="1" max="9" @bind="CurrentGalaxy" />
            <label>System</label>
            <input type="number" min="1" max="499" @bind="CurrentSystem" />
            <button class="nav-button" @onclick="LoadSystem">Go</button>
        </div>
        <button class="nav-button" @onclick="NextSystem">&gt;</button>
    </div>

    <table class="galaxy-table">
        <thead>
            <tr>
                <th>Pos</th>
                <th>Image</th>
                <th>Planet Name</th>
                <th>Player (Status)</th>
                <th>Alliance</th>
                <th>Debris</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (CurrentPlanets != null)
            {
                @foreach (var planet in CurrentPlanets)
                {
                    <tr class="planet-row">
                        <td>@planet.Position</td>
                        <td>
                            @if (planet.IsOccupied)
                            {
                                <img src="@planet.Image" class="planet-img" />
                            }
                        </td>
                        <td>
                            @if (planet.IsOccupied)
                            {
                                <span class="@(planet.IsMyPlanet ? "status-occupied" : "status-enemy")">@planet.Name</span>
                            }
                            else
                            {
                                <span class="status-vacant">Empty Space</span>
                            }
                        </td>
                        <td>
                            @if (planet.IsOccupied)
                            {
                                <span>@planet.PlayerName</span>
                            }
                        </td>
                        <td>@planet.Alliance</td>
                        <td>
                            @if (planet.HasDebris)
                            {
                                <div class="debris-info">
                                    M: @planet.DebrisMetal<br/>
                                    C: @planet.DebrisCrystal
                                </div>
                            }
                        </td>
                        <td>
                            @if (planet.IsOccupied && !planet.IsMyPlanet)
                            {
                                <button class="action-btn" @onclick="() => SendFleet(planet.Position, 1)">Attack</button>
                                <button class="action-btn" @onclick="() => SendFleet(planet.Position, 2)">Espionage</button>
                            }
                            else if (!planet.IsOccupied)
                            {
                                <button class="action-btn" style="background-color: #FF9800" @onclick="() => SendFleet(planet.Position, 3)">Colonize</button>
                            }
                            
                            @if (planet.HasDebris)
                            {
                                <button class="action-btn" style="background-color: #9C27B0" @onclick="() => SendFleet(planet.Position, 4)">Recycle</button>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

@code {
    private int CurrentGalaxy = 1;
    private int CurrentSystem = 1;
    private List<GalaxyPlanet> CurrentPlanets;

    protected override void OnInitialized()
    {
        LoadSystem();
    }

    private void LoadSystem()
    {
        CurrentPlanets = GalaxyService.GetSystem(CurrentGalaxy, CurrentSystem);
    }

    private void PrevSystem()
    {
        if (CurrentSystem > 1)
        {
            CurrentSystem--;
            LoadSystem();
        }
    }

    private void NextSystem()
    {
        if (CurrentSystem < 499)
        {
            CurrentSystem++;
            LoadSystem();
        }
    }

    private void SendFleet(int position, int missionCode)
    {
        // 1=Attack, 2=Espionage, 3=Colonize, 4=Recycle
        // We will pass parameters via Query String to Fleet Page
        string mission = missionCode switch 
        {
            1 => "Attack",
            2 => "Espionage",
            3 => "Colonize",
            4 => "Recycle",
            _ => "Attack"
        };
        
        Navigation.NavigateTo($"/fleet?galaxy={CurrentGalaxy}&system={CurrentSystem}&position={position}&mission={mission}");
    }
}
