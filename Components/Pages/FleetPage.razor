@page "/fleet"
@using myapp.Services
@using Microsoft.AspNetCore.WebUtilities
@inject NavigationManager Navigation
@inject ResourceService ResourceService
@inject FleetService FleetService
@inject GalaxyService GalaxyService
@implements IDisposable

<PageTitle>Fleet</PageTitle>

<div class="ogame-container">
    <!-- Banner -->
    <div class="ogame-banner" style="background-image: url('assets/banners/fleet-banner.jpg');">
        <h2>Fleet Command</h2>
        <p>Manage your ships and launch missions</p>
    </div>

    <!-- Fleet Activity -->
    <div class="ogame-panel mb-lg">
        <h3>Fleet Movements</h3>
        @if (FleetService.HasAttackInProgress())
        {
            <div style="margin: 10px 0; padding: 10px; border-radius: 5px; font-weight: bold; background-color: rgba(255, 152, 0, 0.15); color: #ffb74d;">
                ‚öîÔ∏è Attack in progress.
            </div>
        }
        @if (FleetService.HasIncomingAttack())
        {
            <div style="margin: 10px 0; padding: 10px; border-radius: 5px; font-weight: bold; background-color: rgba(244, 67, 54, 0.15); color: #ef5350;">
                üö® Incoming attack detected.
            </div>
        }
        @if (FleetService.ActiveFleets.Any())
        {
            <div style="display: grid; gap: 10px; margin-top: 15px;">
                @foreach (var mission in FleetService.ActiveFleets)
                {
                    var timeRemaining = GetTimeRemaining(mission);
                    <div class="ogame-card" style="padding: 15px;">
                        <div style="width: 100%; text-align: left;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="color: var(--color-accent-gold);">@(mission.IsIncomingAttack ? "Incoming Attack" : mission.MissionType)</strong>
                                <span class="ogame-badge ogame-badge-@(mission.Status == FleetStatus.Return ? "warning" : "success")">
                                    @mission.Status
                                </span>
                            </div>
                            <!-- Countdown Timer -->
                            <div style="background-color: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 5px; margin: 10px 0; text-align: center;">
                                <div style="font-size: 1.2em; font-weight: bold; color: var(--color-accent-gold);">
                                    @if (mission.Status == FleetStatus.Flight)
                                    {
                                        <span>‚è±Ô∏è Time to Arrival: @FormatTimeSpan(timeRemaining)</span>
                                    }
                                    else
                                    {
                                        <span>‚è±Ô∏è Time to Return: @FormatTimeSpan(timeRemaining)</span>
                                    }
                                </div>
                                <div style="font-size: 0.8em; color: var(--color-text-muted); margin-top: 4px;">
                                    Arrival: @mission.ArrivalTime.ToString("HH:mm:ss") | 
                                    Return: @mission.ReturnTime.ToString("HH:mm:ss")
                                </div>
                            </div>
                            <div class="text-muted" style="font-size: 0.9em;">
                                <div>Target: [@mission.TargetCoordinates]</div>
                                <div style="margin-top: 5px;">
                                    Ships:
                                    @foreach(var s in mission.Ships)
                                    {
                                        <span style="margin-right: 10px;">@s.Key: @s.Value</span>
                                    }
                                </div>
                                @if(mission.Cargo.Count > 0)
                                {
                                    <div style="margin-top: 5px;">
                                        Cargo:
                                        @if(mission.Cargo.ContainsKey("Metal"))
                                        {
                                            <span style="margin-right: 10px;">Metal: @mission.Cargo["Metal"].ToString("N0")</span>
                                        }
                                        @if(mission.Cargo.ContainsKey("Crystal"))
                                        {
                                            <span style="margin-right: 10px;">Crystal: @mission.Cargo["Crystal"].ToString("N0")</span>
                                        }
                                        @if(mission.Cargo.ContainsKey("Deuterium"))
                                        {
                                            <span>Deuterium: @mission.Cargo["Deuterium"].ToString("N0")</span>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <p class="text-muted">No active fleet movements.</p>
        }
    </div>

    <!-- Send Fleet Section -->
    <div class="ogame-panel">
        <h3>Send Fleet</h3>

@if (!string.IsNullOrEmpty(errorMessage))
        {
            <div style="color: var(--color-danger); margin: 10px 0; padding: 10px; background-color: rgba(244, 67, 54, 0.1); border-radius: 5px; font-weight: bold;">
                @errorMessage
            </div>
        }

        <!-- Target & Mission Selection -->
        <div style="margin: 15px 0; padding: 15px; background-color: var(--color-bg-tertiary); border-radius: 5px;">
            <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                <div>
                    <label style="margin-right: 10px; font-weight: bold;">Target:</label>
                    <label>G:</label>
                    <input type="number" min="1" max="10" @bind="TargetGalaxy" style="width:50px; margin-right: 5px; padding: 5px; background-color: var(--color-bg-primary); color: white; border: 1px solid var(--color-border-medium); border-radius: 3px;" />
                    <label>S:</label>
                    <input type="number" min="1" max="10" @bind="TargetSystem" style="width:50px; margin-right: 5px; padding: 5px; background-color: var(--color-bg-primary); color: white; border: 1px solid var(--color-border-medium); border-radius: 3px;" />
                    <label>P:</label>
                    <input type="number" @bind="TargetPosition" style="width:50px; padding: 5px; background-color: var(--color-bg-primary); color: white; border: 1px solid var(--color-border-medium); border-radius: 3px;" />
                </div>

                <div>
                    <label style="margin-right: 10px; font-weight: bold;">Mission:</label>
                    <select @bind="SelectedMission" style="padding: 5px; background-color: var(--color-bg-primary); color: white; border: 1px solid var(--color-border-medium); border-radius: 3px;">
                        <option value="Attack">Attack</option>
                        <option value="Transport">Transport</option>
                        <option value="Espionage">Espionage</option>
                        <option value="Deploy">Deploy</option>
                        <option value="Colonize">Colonize</option>
                        <option value="Recycle">Recycle</option>
                        <option value="Expedition">Expedition</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Ships Selection Grid - Golden Ratio Cards (Responsive) -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: clamp(15px, 3vw, 30px); margin-top: 20px; justify-items: center;">
            @foreach (var ship in GetFilteredShips())
            {
                var count = FleetService.GetShipCount(ship.Id);
                if(count > 0)
                {
                    var input = GetInputModel(ship.Id);
                    // Golden ratio: height = width * 1.618
                    // Responsive width using clamp for min/max bounds - doubled size

                    <div class="ogame-card" style="width: 100%; max-width: 320px; aspect-ratio: 1 / 1.618; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: clamp(8px, 1.5vw, 12px); box-sizing: border-box;">
                        <!-- Image section - larger relative to card -->
                        <div style="flex: 0 0 auto; display: flex; align-items: center; justify-content: center; padding: clamp(4px, 1vw, 8px);">
                            <img src="@ship.Image" alt="@ship.Name" style="width: clamp(100px, 12vw, 140px); height: clamp(100px, 12vw, 140px); object-fit: contain;" />
                        </div>
                        
                        <!-- Text section with reduced spacing -->
                        <div style="display: flex; flex-direction: column; align-items: center; width: 100%; margin-top: clamp(4px, 0.8vw, 8px);">
                            <h3 style="font-size: clamp(1em, 1.8vw, 1.3em); margin: 0 0 clamp(4px, 0.8vw, 8px) 0; text-align: center; line-height: 1.2;">@ship.Name</h3>
                            <div class="ogame-badge" style="font-size: clamp(0.9em, 1.3vw, 1.1em);">@count available</div>
                        </div>
                        
                        <!-- Input section at bottom with reduced spacing -->
                        <div style="width: 100%; margin-top: auto; padding-top: clamp(8px, 1.5vw, 12px);">
                            <input type="number" @bind="input.QuantityToSend" min="0" max="@count"
                                   style="width: 100%; padding: clamp(6px, 1.2vw, 10px); margin-bottom: clamp(6px, 1.2vw, 10px); background-color: var(--color-bg-primary); color: white; border: 1px solid var(--color-border-medium); border-radius: 3px; text-align: center; font-size: clamp(0.9em, 1.3vw, 1.1em); box-sizing: border-box;" />
                            <button class="ogame-btn ogame-btn-secondary ogame-btn-sm"
                                    style="width: 100%; font-size: clamp(0.85em, 1.2vw, 1em); padding: clamp(6px, 1.2vw, 10px); box-sizing: border-box;"
                                    @onclick="() => input.QuantityToSend = count">
                                All
                            </button>
                        </div>
                    </div>
                }
            }
        </div>

        <!-- Flight Calculation -->
        <div style="margin-top: 20px; text-align: center;">
            <button class="ogame-btn ogame-btn-primary ogame-btn-lg" @onclick="CalculateFlight">
                Calculate Flight
            </button>

            @if(calculatedFlightTime > TimeSpan.Zero)
            {
                <div style="margin-top: 15px; padding: 15px; background-color: var(--color-bg-tertiary); border-radius: 5px;">
                    <div style="font-size: 1.1em; margin-bottom: 10px;">
                        <div><strong>Duration:</strong> @calculatedFlightTime.ToString(@"hh\:mm\:ss")</div>
                        <div><strong>Fuel Cost:</strong> @calculatedFuel.ToString("N0") Deuterium</div>
                    </div>
                    <button class="ogame-btn ogame-btn-success ogame-btn-lg" @onclick="LaunchFleet">
                        üöÄ Launch Fleet
                    </button>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private System.Threading.Timer? _timer;

    private int _targetGalaxy = 1;
    private int _targetSystem = 1;
    private int TargetPosition = 1;
    private string SelectedMission = "Attack";
    private string errorMessage = "";

    // Properties with validation to enforce limits
    private int TargetGalaxy
    {
        get => _targetGalaxy;
        set => _targetGalaxy = Math.Clamp(value, 1, GalaxyService.MaxGalaxies);
    }

    private int TargetSystem
    {
        get => _targetSystem;
        set => _targetSystem = Math.Clamp(value, 1, GalaxyService.MaxSystemsPerGalaxy);
    }

    private TimeSpan calculatedFlightTime;
    private long calculatedFuel;

    public class FleetInputModel
    {
        public string ShipId { get; set; }
        public int QuantityToSend { get; set; }
    }

    private List<FleetInputModel> inputs = new();

    protected override void OnInitialized()
    {
        // Set defaults to Home Planet
        _targetGalaxy = GalaxyService.HomeGalaxy;
        _targetSystem = GalaxyService.HomeSystem;
        TargetPosition = GalaxyService.HomePosition;

        FleetService.OnChange += RefreshState;
        ResourceService.OnChange += RefreshState;
        Navigation.LocationChanged += OnLocationChanged;

        _timer = new System.Threading.Timer(_ => InvokeAsync(StateHasChanged), null, 0, 1000);

        foreach(var s in FleetService.ShipDefinitions)
        {
            inputs.Add(new FleetInputModel { ShipId = s.Id });
        }

        ApplyQueryParameters();
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        ApplyQueryParameters();
        InvokeAsync(StateHasChanged);
    }

    private void ApplyQueryParameters()
    {
        var uri = new Uri(Navigation.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("galaxy", out var g) && int.TryParse(g, out var galaxy) &&
            query.TryGetValue("system", out var s) && int.TryParse(s, out var system) &&
            query.TryGetValue("position", out var p) && int.TryParse(p, out var position))
        {
            TargetGalaxy = galaxy;
            TargetSystem = system;
            TargetPosition = position;
            SelectedMission = query.TryGetValue("mission", out var m) ? m.ToString() : "Attack";
        }
        else
        {
            TargetGalaxy = GalaxyService.HomeGalaxy;
            TargetSystem = GalaxyService.HomeSystem;
            TargetPosition = GalaxyService.HomePosition;
            SelectedMission = "Attack";
        }
    }

    private List<Ship> GetFilteredShips()
    {
        var ships = FleetService.ShipDefinitions;
        
        return SelectedMission switch
        {
            "Espionage" => ships.Where(s => s.IsEspionageCapable).ToList(),
            "Colonize" => ships.Where(s => s.IsColonizationCapable).ToList(),
            "Recycle" => ships.Where(s => s.IsRecyclingCapable).ToList(),
            _ => ships.ToList()
        };
    }

    private FleetInputModel GetInputModel(string id) => inputs.First(i => i.ShipId == id);

    private async void RefreshState()
    {
        await InvokeAsync(StateHasChanged);
    }

    private Dictionary<string, int> GetSelectedShips()
    {
        var dict = new Dictionary<string, int>();
        foreach(var i in inputs)
        {
            if (i.QuantityToSend > 0)
            {
                dict.Add(i.ShipId, i.QuantityToSend);
            }
        }
        return dict;
    }

    private void CalculateFlight()
    {
        var ships = GetSelectedShips();
        if (!ships.Any())
        {
            errorMessage = "No ships selected.";
            calculatedFlightTime = TimeSpan.Zero;
            return;
        }

        errorMessage = "";
        calculatedFlightTime = FleetService.CalculateFlightTime(ships, TargetGalaxy, TargetSystem, TargetPosition);
        calculatedFuel = FleetService.CalculateFuelConsumption(ships, TargetGalaxy, TargetSystem, TargetPosition);
    }

    private TimeSpan GetTimeRemaining(FleetMission mission)
    {
        if (mission.Status == FleetStatus.Flight)
        {
            return mission.ArrivalTime > DateTime.Now ? mission.ArrivalTime - DateTime.Now : TimeSpan.Zero;
        }
        else if (mission.Status == FleetStatus.Return)
        {
            return mission.ReturnTime > DateTime.Now ? mission.ReturnTime - DateTime.Now : TimeSpan.Zero;
        }
        return TimeSpan.Zero;
    }

    private string FormatTimeSpan(TimeSpan timeSpan)
    {
        if (timeSpan.TotalDays >= 1)
        {
            return $"{timeSpan.Days}d {timeSpan.Hours:D2}:{timeSpan.Minutes:D2}:{timeSpan.Seconds:D2}";
        }
        return $"{timeSpan.Hours:D2}:{timeSpan.Minutes:D2}:{timeSpan.Seconds:D2}";
    }

    private void LaunchFleet()
    {
        // Validate galaxy and system limits
        if (TargetGalaxy < 1 || TargetGalaxy > GalaxyService.MaxGalaxies)
        {
            errorMessage = $"Galaxy must be between 1 and {GalaxyService.MaxGalaxies}.";
            return;
        }
        if (TargetSystem < 1 || TargetSystem > GalaxyService.MaxSystemsPerGalaxy)
        {
            errorMessage = $"System must be between 1 and {GalaxyService.MaxSystemsPerGalaxy}.";
            return;
        }

        var ships = GetSelectedShips();
        var error = FleetService.SendFleet(ships, TargetGalaxy, TargetSystem, TargetPosition, SelectedMission);

        if (error != null)
        {
            errorMessage = error;
        }
        else
        {
            errorMessage = "";
            calculatedFlightTime = TimeSpan.Zero;
            foreach(var i in inputs) i.QuantityToSend = 0;
        }
    }

    public void Dispose()
    {
        _timer?.Dispose();
        Navigation.LocationChanged -= OnLocationChanged;
        FleetService.OnChange -= RefreshState;
        ResourceService.OnChange -= RefreshState;
    }
}
