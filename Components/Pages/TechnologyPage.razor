@page "/technologies"
@using myapp.Services
@inject ResourceService ResourceService
@inject TechnologyService TechnologyService
@inject RequirementService RequirementService
@inject DevModeService DevModeService
@implements IDisposable

<PageTitle>Technologies</PageTitle>

<div class="ogame-container">
    <!-- Banner -->
    <div class="ogame-banner" style="background-image: url('assets/banners/tech-banner.jpg');">
        <h2>Technologies</h2>
        <p>Research to unlock new capabilities</p>
    </div>

    <!-- Research Queue -->
    @if(TechnologyService.CurrentResearch != null)
    {
        <div class="ogame-queue-container mb-lg">
            <h3>Researching: @TechnologyService.CurrentResearch.Title</h3>
            <div class="ogame-queue-item">
                <div>
                    <div><strong>Level @(TechnologyService.CurrentResearch.Level + 1)</strong></div>
                    <div class="text-muted" style="font-size: 0.9em;">
                        Duration: @TechnologyService.CurrentResearch.ConstructionDuration.ToString(@"hh\:mm\:ss")
                    </div>
                </div>
                <span class="ogame-queue-timer">
                    @TechnologyService.CurrentResearch.TimeRemaining.ToString(@"hh\:mm\:ss")
                </span>
            </div>
            <button class="ogame-btn ogame-btn-danger ogame-btn-sm mt-sm" @onclick="CancelResearch">
                Cancel Research
            </button>
        </div>
    }

    <!-- Technologies Grid -->
    <div class="ogame-grid-4">
        @foreach (var tech in TechnologyService.Technologies)
        {
            <div class="ogame-card">
                <!-- Level Badge -->
                <div class="ogame-badge">Level @tech.Level</div>

                <!-- Technology Image -->
                <img src="@tech.Image" alt="@tech.Title" />

                <!-- Technology Info -->
                <h3>@tech.Title</h3>
                <p class="text-muted">@tech.Description</p>

                <!-- Costs -->
                <div class="ogame-cost-section">
                    @if(tech.MetalCost > 0)
                    {
                        <div class="ogame-cost-item">
                            <img src="assets/common/metal-icon.png" alt="Metal" />
                            Metal: @tech.MetalCost.ToString("N0")
                        </div>
                    }
                    @if(tech.CrystalCost > 0)
                    {
                        <div class="ogame-cost-item">
                            <img src="assets/common/crystal-icon.png" alt="Crystal" />
                            Crystal: @tech.CrystalCost.ToString("N0")
                        </div>
                    }
                    @if(tech.DeuteriumCost > 0)
                    {
                        <div class="ogame-cost-item">
                            <img src="assets/common/deuterium-icon.png" alt="Deuterium" />
                            Deuterium: @tech.DeuteriumCost.ToString("N0")
                        </div>
                    }
                    @if(tech.EnergyCost > 0)
                    {
                        <div class="ogame-cost-item">
                            <img src="assets/common/energy-icon.png" alt="Energy" />
                            Energy: @tech.EnergyCost.ToString("N0")
                        </div>
                    }

                    <div class="text-muted" style="margin-top: 8px; font-size: 0.85em;">
                        Duration: @TechnologyService.GetResearchTime(tech).ToString(@"hh\:mm\:ss")
                    </div>

                    <!-- Requirements -->
                    @if (tech.Requirements != null && tech.Requirements.Any())
                    {
                        <div style="margin-top: 10px; font-size: 0.85em; border-top: 1px solid var(--color-border-medium); padding-top: 8px;">
                            <strong class="text-muted">Requirements:</strong>
                            <ul style="list-style-type: none; padding-left: 0; margin: 5px 0;">
                                @foreach (var req in tech.Requirements)
                                {
                                    <li class="text-muted">@req.Name (Lvl @req.Level)</li>
                                }
                            </ul>
                        </div>
                    }
                </div>

                <!-- Action Buttons -->
                @if (TechnologyService.CurrentResearch == null)
                {
                    @if (TechnologyService.RequirementsMet(tech))
                    {
                        <button class="ogame-btn ogame-btn-primary ogame-btn-block"
                                @onclick="() => StartResearch(tech)">
                            Research Level @(tech.Level + 1)
                        </button>
                    }
                    else
                    {
                        <button class="ogame-btn ogame-btn-block" disabled>
                            Requirements Not Met
                        </button>
                    }
                }
                else if (TechnologyService.CurrentResearch == tech)
                {
                    <button class="ogame-btn ogame-btn-secondary ogame-btn-block" disabled>
                        Researching...
                    </button>
                }
                else
                {
                    <button class="ogame-btn ogame-btn-block" disabled>
                        Lab Busy
                    </button>
                }
            </div>
        }
    </div>
</div>

@code {
    private System.Threading.Timer? _timer;

    protected override void OnInitialized()
    {
        ResourceService.OnChange += RefreshState;
        TechnologyService.OnChange += RefreshState;
        DevModeService.OnChange += RefreshState;
        // Start a local UI timer to refresh the page every second
        _timer = new System.Threading.Timer(_ => InvokeAsync(StateHasChanged), null, 0, 1000);
    }

    private async void RefreshState()
    {
        await InvokeAsync(StateHasChanged);
    }

    private void StartResearch(Technology tech)
    {
        TechnologyService.StartResearch(tech);
    }

    private void CancelResearch()
    {
        TechnologyService.CancelResearch();
    }

    public void Dispose()
    {
        _timer?.Dispose();
        ResourceService.OnChange -= RefreshState;
        TechnologyService.OnChange -= RefreshState;
        DevModeService.OnChange -= RefreshState;
    }
}
