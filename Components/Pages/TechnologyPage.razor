@page "/technologies"
@using myapp.Services
@inject ResourceService ResourceService
@inject TechnologyService TechnologyService
@inject RequirementService RequirementService
@implements IDisposable

<div class="ogame-banner" style="background-image: url('buildings-banner.jpg');">
    <h2>Technologies</h2>
</div>

@if(TechnologyService.CurrentResearch != null)
{
    <div class="ogame-queue-container">
        <h3>Researching: @TechnologyService.CurrentResearch.Title</h3>
        <p>Level: @(TechnologyService.CurrentResearch.Level + 1)</p>
        <p>Time Remaining: @TechnologyService.CurrentResearch.TimeRemaining.ToString(@"hh\:mm\:ss")</p>
        <button class="btn btn-secondary" @onclick="CancelResearch">Cancel</button>
    </div>
}

<div class="ogame-grid">
    @foreach (var tech in TechnologyService.Technologies)
    {
        <div class="ogame-card">
            <div class="ogame-count-badge">Level: @tech.Level</div>
            <img src="@tech.Image" alt="@tech.Title" />
            <h3>@tech.Title</h3>
            <p>@tech.Description</p>
            
            <div class="ogame-cost-section">
                @if(tech.MetalCost > 0) { <div class="ogame-cost-item">Metal: @tech.MetalCost.ToString("N0")</div> }
                @if(tech.CrystalCost > 0) { <div class="ogame-cost-item">Crystal: @tech.CrystalCost.ToString("N0")</div> }
                @if(tech.DeuteriumCost > 0) { <div class="ogame-cost-item">Deuterium: @tech.DeuteriumCost.ToString("N0")</div> }
                @if(tech.EnergyCost > 0) { <div class="ogame-cost-item">Energy: @tech.EnergyCost.ToString("N0")</div> }
                
                <div class="ogame-cost-item">Duration: @tech.Duration.ToString(@"hh\:mm\:ss")</div>

                @if (tech.Requirements != null && tech.Requirements.Any())
                {
                     <div class="ogame-requirements-section">
                        <strong>Requirements:</strong>
                        <ul style="list-style-type: none; padding-left: 0; margin: 5px 0;">
                            @foreach (var req in tech.Requirements)
                            {
                                 <li>@req.Name (Lvl @req.Level)</li>
                            }
                        </ul>
                    </div>
                }
            </div>

            <div class="ogame-card-actions">
            @if (TechnologyService.CurrentResearch == null)
            {
                if (TechnologyService.RequirementsMet(tech))
                {
                     <button class="btn btn-primary" @onclick="() => StartResearch(tech)">Research</button>
                }
                else
                {
                    
                }
            }
            else if (TechnologyService.CurrentResearch == tech)
            {
                <button class="btn btn-secondary" disabled>Researching...</button>
            }
            else
            {
                 <button class="btn btn-secondary" disabled>Queue Busy</button>
            }
            </div>
        </div>
    }
</div>

@code {
    private System.Threading.Timer? _timer;

    protected override void OnInitialized()
    {
        ResourceService.OnChange += RefreshState;
        TechnologyService.OnChange += RefreshState;
        // Start a local UI timer to refresh the page every second
        _timer = new System.Threading.Timer(_ => InvokeAsync(StateHasChanged), null, 0, 1000);
    }

    private async void RefreshState()
    {
        await InvokeAsync(StateHasChanged);
    }

    private void StartResearch(Technology tech)
    {
        TechnologyService.StartResearch(tech);
    }

    private void CancelResearch()
    {
        TechnologyService.CancelResearch();
    }

    public void Dispose()
    {
        _timer?.Dispose();
        ResourceService.OnChange -= RefreshState;
        TechnologyService.OnChange -= RefreshState;
    }
}
