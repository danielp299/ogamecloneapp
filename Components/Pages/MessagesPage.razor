@page "/messages"
@using myapp.Services
@inject MessageService MessageService
@implements IDisposable

<style>
    .messages-container {
        color: white;
        padding: 20px;
        max-width: 1000px;
        margin: 0 auto;
    }
    
    .messages-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        background-color: #222;
        padding: 15px;
        border-radius: 5px;
    }
    
    .message-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .message-item {
        background-color: #333;
        border: 1px solid #444;
        border-radius: 5px;
        overflow: hidden;
    }
    
    .message-header {
        padding: 10px 15px;
        background-color: #444;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .message-header:hover {
        background-color: #555;
    }
    
    .message-unread {
        border-left: 5px solid #2196F3;
    }
    
    .message-body {
        padding: 15px;
        background-color: #2a2a2a;
        border-top: 1px solid #444;
        line-height: 1.5;
    }
    
    .msg-type {
        font-size: 0.8em;
        padding: 2px 6px;
        border-radius: 3px;
        margin-right: 10px;
        font-weight: bold;
    }
    
    .type-combat { background-color: #d32f2f; }
    .type-espionage { background-color: #f57c00; }
    .type-expedition { background-color: #7b1fa2; }
    .type-general { background-color: #1976d2; }
    
    .btn-delete {
        background-color: #c62828;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.8em;
    }
</style>

<div class="messages-container">
    <div class="messages-header">
        <h2>Communications (@MessageService.GetUnreadCount() unread)</h2>
        <button class="btn-delete" @onclick="MessageService.DeleteAll">Delete All</button>
    </div>

    @if (!MessageService.Messages.Any())
    {
        <div style="text-align: center; padding: 40px; color: #777;">
            No messages received.
        </div>
    }
    else
    {
        <div class="message-list">
            @foreach (var msg in MessageService.Messages)
            {
                <div class="message-item @(!msg.IsRead ? "message-unread" : "")">
                    <div class="message-header" @onclick="() => ToggleMessage(msg)">
                        <div>
                            <span class="msg-type @GetClassForType(msg.Type)">@msg.Type</span>
                            <span style="font-weight: bold;">@msg.Subject</span>
                            <span style="color: #aaa; font-size: 0.8em; margin-left: 10px;">@msg.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</span>
                        </div>
                        <button class="btn-delete" @onclick:stopPropagation="true" @onclick="() => Delete(msg.Id)">X</button>
                    </div>
                    
                    @if (ExpandedMessages.Contains(msg.Id))
                    {
                        <div class="message-body">
                            @((MarkupString)msg.Body)
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    private HashSet<Guid> ExpandedMessages = new();

    protected override void OnInitialized()
    {
        MessageService.OnChange += RefreshState;
    }

    private void RefreshState()
    {
        InvokeAsync(StateHasChanged);
    }
    
    private void ToggleMessage(GameMessage msg)
    {
        if (ExpandedMessages.Contains(msg.Id))
        {
            ExpandedMessages.Remove(msg.Id);
        }
        else
        {
            ExpandedMessages.Add(msg.Id);
            if (!msg.IsRead)
            {
                MessageService.MarkAsRead(msg.Id);
            }
        }
    }
    
    private void Delete(Guid id)
    {
        MessageService.DeleteMessage(id);
    }
    
    private string GetClassForType(string type)
    {
        return type.ToLower() switch
        {
            "combat" => "type-combat",
            "espionage" => "type-espionage",
            "expedition" => "type-expedition",
            _ => "type-general"
        };
    }

    public void Dispose()
    {
        MessageService.OnChange -= RefreshState;
    }
}
