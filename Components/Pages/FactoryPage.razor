@page "/factory"
@using myapp.Services
@inject ResourceService ResourceService
@inject FleetService FleetService
@inject BuildingService BuildingService
@inject RequirementService RequirementService
@inject TechnologyService TechnologyService
@implements IDisposable

<PageTitle>Shipyard</PageTitle>

<div class="ogame-container">
    <!-- Banner -->
    <div class="ogame-banner" style="background-image: url('assets/banners/fleet-banner.jpg');">
        <h2>Shipyard</h2>
        <p>Construct powerful spaceships</p>
    </div>

    <!-- Production Queue -->
    @if (FleetService.ConstructionQueue.Any())
    {
        <div class="ogame-queue-container mb-lg">
            <h3>Current Production</h3>
            @foreach (var item in FleetService.ConstructionQueue)
            {
                <div class="ogame-queue-item">
                    <div>
                        <strong>@item.Ship.Name</strong> - @item.Quantity units remaining
                        <div class="text-muted" style="font-size: 0.9em;">
                            Next unit: @item.Ship.BaseDuration.ToString(@"hh\:mm\:ss")
                        </div>
                    </div>
                    <span class="ogame-queue-timer">@item.TimeRemaining.ToString(@"hh\:mm\:ss")</span>
                </div>
            }
        </div>
    }

    <!-- Ships Grid -->
    <div class="ogame-grid-4">
        @foreach (var ship in FleetService.ShipDefinitions)
        {
            var vm = GetViewModel(ship.Id);
            var currentCount = FleetService.GetShipCount(ship.Id);

            <div class="ogame-card">
                <!-- Count Badge -->
                <div class="ogame-badge">Hangar: @currentCount</div>

                <!-- Ship Image -->
                <img src="@ship.Image" alt="@ship.Name" />

                <!-- Ship Info -->
                <h3>@ship.Name</h3>
                <p class="text-muted">@ship.Description</p>

                <!-- Stats & Costs -->
                <div class="ogame-cost-section">
                    <div class="ogame-cost-item">
                        <img src="assets/common/metal-icon.png" alt="Metal" />
                        Metal: @ship.MetalCost.ToString("N0")
                    </div>
                    <div class="ogame-cost-item">
                        <img src="assets/common/crystal-icon.png" alt="Crystal" />
                        Crystal: @ship.CrystalCost.ToString("N0")
                    </div>
                    @if(ship.DeuteriumCost > 0)
                    {
                        <div class="ogame-cost-item">
                            <img src="assets/common/deuterium-icon.png" alt="Deuterium" />
                            Deuterium: @ship.DeuteriumCost.ToString("N0")
                        </div>
                    }

                    <div class="text-muted" style="margin-top: 8px; font-size: 0.85em;">
                        <div>Structure: @ship.Structure.ToString("N0")</div>
                        <div>Speed: @ship.BaseSpeed</div>
                        <div>Cargo: @ship.Capacity.ToString("N0")</div>
                        <div>Build Time: @ship.BaseDuration.ToString(@"hh\:mm\:ss")</div>
                    </div>

                    <!-- Requirements -->
                    @if (ship.Requirements != null && ship.Requirements.Any())
                    {
                        <div style="margin-top: 10px; font-size: 0.85em; border-top: 1px solid var(--color-border-medium); padding-top: 8px;">
                            <strong class="text-muted">Requirements:</strong>
                            <ul style="list-style-type: none; padding-left: 0; margin: 5px 0;">
                                @foreach (var req in ship.Requirements)
                                {
                                    var building = BuildingService.Buildings.FirstOrDefault(b => b.Title == req.Key);
                                    var tech = TechnologyService.Technologies.FirstOrDefault(t => t.Title == req.Key);
                                    int currentLevel = building?.Level ?? tech?.Level ?? 0;
                                    bool met = currentLevel >= req.Value;

                                    <li style="color: @(met ? "var(--color-success)" : "var(--color-danger)")">
                                        @req.Key (Lvl @req.Value)
                                        <span class="text-muted" style="font-size: 0.9em;"> - Current: @currentLevel</span>
                                    </li>
                                }
                            </ul>
                        </div>
                    }
                </div>

                <!-- Quantity Selector -->
                <div style="display: flex; justify-content: space-around; width: 100%; margin: 10px 0; gap: 5px;">
                    <button class="ogame-btn ogame-btn-secondary ogame-btn-sm" @onclick="() => AddToQuantityToBuild(vm, 1)">+1</button>
                    <button class="ogame-btn ogame-btn-secondary ogame-btn-sm" @onclick="() => AddToQuantityToBuild(vm, 10)">+10</button>
                    <button class="ogame-btn ogame-btn-secondary ogame-btn-sm" @onclick="() => AddToQuantityToBuild(vm, 50)">+50</button>
                    <button class="ogame-btn ogame-btn-secondary ogame-btn-sm" @onclick="() => AddToQuantityToBuild(vm, 100)">+100</button>
                </div>

                <!-- Input & Build Button -->
                <div style="display: flex; width: 100%; gap: 10px; align-items: center;">
                    <input type="number" @bind="vm.QuantityInput" min="0" max="9999"
                           style="flex: 1; padding: 8px; text-align: center; background-color: var(--color-bg-primary); color: white; border: 1px solid var(--color-border-medium); border-radius: 5px;" />

                    @if(CanBuild(ship))
                    {
                        <button class="ogame-btn ogame-btn-primary" style="flex: 1;" @onclick="async () => await BuildShip(ship, vm)">
                            Build (@vm.QuantityInput)
                        </button>
                    }
                    else
                    {
                        <button class="ogame-btn" style="flex: 1;" disabled>
                            Locked
                        </button>
                    }
                </div>
            </div>
        }
    </div>
</div>

@code {
    public class ShipViewModel
    {
        public string ShipId { get; set; }
        public int QuantityInput { get; set; } = 0;
    }

    private List<ShipViewModel> viewModels = new();

    protected override void OnInitialized()
    {
        FleetService.OnChange += RefreshState;
        ResourceService.OnChange += RefreshState;

        foreach(var ship in FleetService.ShipDefinitions)
        {
            viewModels.Add(new ShipViewModel { ShipId = ship.Id });
        }
    }

    private async void RefreshState()
    {
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        FleetService.OnChange -= RefreshState;
        ResourceService.OnChange -= RefreshState;
    }

    private ShipViewModel GetViewModel(string shipId) => viewModels.First(v => v.ShipId == shipId);

    private void AddToQuantityToBuild(ShipViewModel vm, int amount)
    {
        vm.QuantityInput += amount;
    }

    private async Task BuildShip(Ship ship, ShipViewModel vm)
    {
        await FleetService.AddToQueueAsync(ship, vm.QuantityInput);
        vm.QuantityInput = 0;
    }

    private bool CanBuild(Ship ship)
    {
        return RequirementService.IsUnlocked(ship.Requirements);
    }
}
