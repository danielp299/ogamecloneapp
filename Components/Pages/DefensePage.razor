@page "/defense"
@using myapp.Services
@inject ResourceService ResourceService
@inject DefenseService DefenseService
@inject BuildingService BuildingService
@inject RequirementService RequirementService
@inject TechnologyService TechnologyService
@implements IDisposable

<PageTitle>Defense</PageTitle>

<div class="ogame-container">
    <!-- Banner -->
    <div class="ogame-banner" style="background-image: url('assets/banners/defense-banner.jpg');">
        <h2>Defense Systems</h2>
        <p>Protect your planet from attacks</p>
    </div>

    <!-- Production Queue -->
    @if (DefenseService.ConstructionQueue.Any())
    {
        <div class="ogame-queue-container mb-lg">
            <h3>Current Production</h3>
            @foreach (var item in DefenseService.ConstructionQueue)
            {
                <div class="ogame-queue-item">
                    <div>
                        <strong>@item.Unit.Name</strong> - @item.Quantity units remaining
                        <div class="text-muted" style="font-size: 0.9em;">
                            Next unit: @item.Unit.BaseDuration.ToString(@"hh\:mm\:ss")
                        </div>
                    </div>
                    <span class="ogame-queue-timer">@item.TimeRemaining.ToString(@"hh\:mm\:ss")</span>
                </div>
            }
        </div>
    }

    <!-- Defense Grid -->
    <div class="ogame-grid-4">
        @foreach (var unit in DefenseService.DefenseDefinitions)
        {
            var vm = GetViewModel(unit.Id);
            var currentCount = DefenseService.GetDefenseCount(unit.Id);

            <div class="ogame-card">
                <!-- Count Badge -->
                <div class="ogame-badge">Built: @currentCount</div>

                <!-- Unit Image -->
                <img src="@unit.Image" alt="@unit.Name" />

                <!-- Unit Info -->
                <h3>@unit.Name</h3>
                <p class="text-muted">@unit.Description</p>

                <!-- Stats & Costs -->
                <div class="ogame-cost-section">
                    <div class="ogame-cost-item">
                        <img src="assets/common/metal-icon.png" alt="Metal" />
                        Metal: @unit.MetalCost.ToString("N0")
                    </div>
                    <div class="ogame-cost-item">
                        <img src="assets/common/crystal-icon.png" alt="Crystal" />
                        Crystal: @unit.CrystalCost.ToString("N0")
                    </div>
                    @if(unit.DeuteriumCost > 0)
                    {
                        <div class="ogame-cost-item">
                            <img src="assets/common/deuterium-icon.png" alt="Deuterium" />
                            Deuterium: @unit.DeuteriumCost.ToString("N0")
                        </div>
                    }

                    <div class="text-muted" style="margin-top: 8px; font-size: 0.85em;">
                        <div>Structure: @unit.Structure.ToString("N0") | Attack: @unit.Attack.ToString("N0")</div>
                        <div>Build Time: @unit.BaseDuration.ToString(@"hh\:mm\:ss")</div>
                    </div>

                    <!-- Requirements -->
                    @if (unit.Requirements != null && unit.Requirements.Any())
                    {
                        <div style="margin-top: 10px; font-size: 0.85em; border-top: 1px solid var(--color-border-medium); padding-top: 8px;">
                            <strong class="text-muted">Requirements:</strong>
                            <ul style="list-style-type: none; padding-left: 0; margin: 5px 0;">
                                @foreach (var req in unit.Requirements)
                                {
                                    var building = BuildingService.Buildings.FirstOrDefault(b => b.Title == req.Key);
                                    var tech = TechnologyService.Technologies.FirstOrDefault(t => t.Title == req.Key);
                                    int currentLevel = building?.Level ?? tech?.Level ?? 0;
                                    bool met = currentLevel >= req.Value;

                                    <li style="color: @(met ? "var(--color-success)" : "var(--color-danger)")">
                                        @req.Key (Lvl @req.Value)
                                        <span class="text-muted" style="font-size: 0.9em;"> - Current: @currentLevel</span>
                                    </li>
                                }
                            </ul>
                        </div>
                    }
                </div>

                <!-- Quantity Selector -->
                <div style="display: flex; justify-content: space-around; width: 100%; margin: 10px 0; gap: 5px;">
                    <button class="ogame-btn ogame-btn-secondary ogame-btn-sm" @onclick="() => AddToQuantity(vm, 1)">+1</button>
                    <button class="ogame-btn ogame-btn-secondary ogame-btn-sm" @onclick="() => AddToQuantity(vm, 10)">+10</button>
                    <button class="ogame-btn ogame-btn-secondary ogame-btn-sm" @onclick="() => AddToQuantity(vm, 50)">+50</button>
                    <button class="ogame-btn ogame-btn-secondary ogame-btn-sm" @onclick="() => AddToQuantity(vm, 100)">+100</button>
                </div>

                <!-- Input & Build Button -->
                <div style="display: flex; width: 100%; gap: 10px; align-items: center;">
                    <input type="number" @bind="vm.QuantityInput" min="0" max="9999"
                           style="flex: 1; padding: 8px; text-align: center; background-color: var(--color-bg-primary); color: white; border: 1px solid var(--color-border-medium); border-radius: 5px;" />

                    @if(CanBuild(unit))
                    {
                        <button class="ogame-btn ogame-btn-primary" style="flex: 1;" @onclick="() => BuildDefense(unit, vm)">
                            Build (@vm.QuantityInput)
                        </button>
                    }
                    else
                    {
                        <button class="ogame-btn" style="flex: 1;" disabled>
                            Locked
                        </button>
                    }
                </div>
            </div>
        }
    </div>
</div>

@code {
    public class DefenseViewModel
    {
        public string UnitId { get; set; }
        public int QuantityInput { get; set; } = 0;
    }

    private List<DefenseViewModel> viewModels = new();

    protected override void OnInitialized()
    {
        DefenseService.OnChange += RefreshState;
        ResourceService.OnChange += RefreshState;

        foreach(var unit in DefenseService.DefenseDefinitions)
        {
            viewModels.Add(new DefenseViewModel { UnitId = unit.Id });
        }
    }

    private async void RefreshState()
    {
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        DefenseService.OnChange -= RefreshState;
        ResourceService.OnChange -= RefreshState;
    }

    private DefenseViewModel GetViewModel(string id) => viewModels.First(v => v.UnitId == id);

    private void AddToQuantity(DefenseViewModel vm, int amount)
    {
        vm.QuantityInput += amount;
    }

    private void BuildDefense(DefenseUnit unit, DefenseViewModel vm)
    {
        DefenseService.AddToQueue(unit, vm.QuantityInput);
        vm.QuantityInput = 0;
    }

    private bool CanBuild(DefenseUnit unit)
    {
        return RequirementService.IsUnlocked(unit.Requirements);
    }
}
