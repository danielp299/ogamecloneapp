@page "/"
@using Microsoft.AspNetCore.Components
@using myapp.Services
@inject NavigationManager Navigation
@inject ResourceService ResourceService
@inject BuildingService BuildingService
@inject GalaxyService GalaxyService
@inject FleetService FleetService
@inject TechnologyService TechnologyService
@inject DefenseService DefenseService
@implements IDisposable

<PageTitle>Home</PageTitle>

<style>
    body {
        font-family: sans-serif;
        margin: 0;
        padding: 0;
        background-color: #111;
        color: #eee;
    }

    main {
        background-color: #000000;
    }

    .home-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .banner {
        background-color: #222;
        padding: 20px;
        text-align: center;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .main-content {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .dashboard-panel {
        background-color: #222;
        padding: 20px;
        border-radius: 10px;
        border: 1px solid #333;
    }
    
    .dashboard-panel h2 {
        margin-top: 0;
        border-bottom: 1px solid #444;
        padding-bottom: 10px;
        font-size: 1.2rem;
        color: #aaa;
    }

    .queue-list, .events-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 300px;
        overflow-y: auto;
    }

    .queue-item, .event-item {
        background-color: #333;
        padding: 10px;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9rem;
    }
    
    .event-item-details {
        display: flex;
        flex-direction: column;
    }
    
    .event-type {
        font-weight: bold;
        color: #ffd700;
    }
    
    .event-coords {
        font-size: 0.8em;
        color: #aaa;
    }

    .queue-item-info {
        display: flex;
        flex-direction: column;
    }

    .queue-item-name {
        font-weight: bold;
    }
    
    .queue-item-timer {
        color: #0f0;
        font-family: monospace;
    }

    .cancel-btn {
        background-color: #800;
        color: #fff;
        border: none;
        padding: 4px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.8em;
    }
    
    .cancel-btn:hover {
        background-color: #a00;
    }

    .planet-card-wrapper {
        display: flex;
        flex-direction: column;
        gap: 5px;
        align-items: center;
    }

    .planet-card {
        background-color: #333;
        padding: 15px;
        border-radius: 5px;
        text-align: center;
        cursor: pointer;
        transition: transform 0.2s;
        width: 150px;
    }
    
    .planet-card:hover {
        transform: scale(1.05);
        background-color: #444;
    }

    .planet-card img {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 10px;
    }

    .planets-section {
        background-color: #222;
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
    }
    
    .planets-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
    }

    .management-options {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        margin-top: 20px;
    }

    .management-options button {
        background-color: #333;
        color: #eee;
        border: 1px solid #555;
        padding: 15px 30px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1.1em;
        transition: background-color 0.2s;
    }

    .management-options button:hover {
        background-color: #555;
    }
    
    .btn-abandon {
        background-color: #800;
        color: #fff;
        border: none;
        padding: 5px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.8em;
        width: 100%;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background-color: #222;
        padding: 20px;
        border-radius: 10px;
        border: 1px solid #555;
        max-width: 400px;
        text-align: center;
        color: white;
    }

    .warning-text {
        color: #ff6666;
        font-size: 0.9em;
        margin: 15px 0;
    }

    .modal-actions {
        display: flex;
        justify-content: space-around;
        gap: 10px;
        margin-top: 20px;
    }
</style>

<div class="home-container">
    <!-- Banner -->
    <div class="banner">
        <h1>Command Center</h1>
        <p>Overview of your empire</p>
    </div>

    <div class="main-content">
        
        <div class="dashboard-grid">
            <!-- 1. Event List (Fleets) -->
            <div class="dashboard-panel">
                <h2>Fleet Movements</h2>
                @if (FleetService.ActiveFleets.Any())
                {
                    <div class="events-list">
                        @foreach (var mission in GetSortedMissions())
                        {
                            var timeStr = GetMissionTime(mission);
                            var isReturn = mission.Status == FleetStatus.Return;
                            <div class="event-item">
                                <div class="event-item-details">
                                    <span class="event-type">@mission.MissionType @(isReturn ? "(Returning)" : "")</span>
                                    <span class="event-coords">
                                        Target: @mission.TargetCoordinates
                                    </span>
                                </div>
                                <div class="queue-item-timer">
                                    @timeStr
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted">No active fleet movements.</p>
                }
            </div>

            <!-- 2. Building Queue -->
            <div class="dashboard-panel">
                <h2>Buildings</h2>
                @if (BuildingService.ConstructionQueue.Any())
                {
                    <div class="queue-list">
                        @foreach (var building in BuildingService.ConstructionQueue)
                        {
                             <div class="queue-item">
                                <div class="queue-item-info">
                                    <span class="queue-item-name">@building.Title</span>
                                    <span style="font-size:0.8em; color:#aaa;">Level @(building.Level + 1)</span>
                                </div>
                                <div class="queue-item-timer">
                                    @building.TimeRemaining.ToString(@"hh\:mm\:ss")
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted">No buildings in construction.</p>
                }
            </div>

            <!-- 3. Research Queue -->
            <div class="dashboard-panel">
                <h2>Research</h2>
                @if (TechnologyService.CurrentResearch != null)
                {
                    <div class="queue-list">
                        <div class="queue-item">
                            <div class="queue-item-info">
                                <span class="queue-item-name">@TechnologyService.CurrentResearch.Title</span>
                                <span style="font-size:0.8em; color:#aaa;">Level @(TechnologyService.CurrentResearch.Level + 1)</span>
                            </div>
                            <div class="queue-item-timer">
                                @TechnologyService.CurrentResearch.TimeRemaining.ToString(@"hh\:mm\:ss")
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <p class="text-muted">No research in progress.</p>
                }
            </div>

            <!-- 4. Shipyard & Defense Queue -->
            <div class="dashboard-panel">
                <h2>Shipyard & Defense</h2>
                <div class="queue-list">
                    @if (!FleetService.ConstructionQueue.Any() && !DefenseService.ConstructionQueue.Any())
                    {
                        <p class="text-muted">Shipyard is idle.</p>
                    }
                    else
                    {
                        <!-- Ships -->
                        @foreach (var shipItem in FleetService.ConstructionQueue)
                        {
                            <div class="queue-item">
                                <div class="queue-item-info">
                                    <span class="queue-item-name">@shipItem.Ship.Name</span>
                                    <span style="font-size:0.8em; color:#aaa;">x @shipItem.Quantity</span>
                                </div>
                                <div class="queue-item-timer">
                                    @shipItem.TimeRemaining.ToString(@"hh\:mm\:ss")
                                </div>
                            </div>
                        }
                        
                        <!-- Defenses -->
                        @foreach (var defItem in DefenseService.ConstructionQueue)
                        {
                            <div class="queue-item">
                                <div class="queue-item-info">
                                    <span class="queue-item-name">@defItem.Unit.Name</span>
                                    <span style="font-size:0.8em; color:#aaa;">x @defItem.Quantity</span>
                                </div>
                                <div class="queue-item-timer">
                                    @defItem.TimeRemaining.ToString(@"hh\:mm\:ss")
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

    </div>

    <!-- Planets -->
    <div class="planets-section">
        <h2 style="color: #aaa; border-bottom: 1px solid #444; padding-bottom: 10px;">Your Planets</h2>
        <div class="planets-grid">
            @foreach (var planet in GalaxyService.PlayerPlanets)
            {
                <div class="planet-card-wrapper">
                    <div class="planet-card" @onclick="() => NavigateToPlanet(planet)">
                        <img src="@planet.Image" alt="@planet.Name" />
                        <div><strong>@planet.Name</strong></div>
                        <div style="font-size:0.9em; color:#aaa;">[@planet.Galaxy:@planet.System:@planet.Position]</div>
                    </div>
                    @if (!planet.IsHomeworld)
                    {
                        <button class="btn-abandon" @onclick="() => ConfirmAbandon(planet)">Abandon</button>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Abandon Confirmation Modal -->
    @if (ShowAbandonConfirmation)
    {
        <div class="modal-overlay">
            <div class="modal-content">
                <h3>Abandon Colony</h3>
                <p>Are you sure you want to abandon <strong>@PlanetToAbandon?.Name</strong>?</p>
                <p class="warning-text">This action cannot be undone. All buildings and resources on this planet will be lost forever.</p>
                <div class="modal-actions">
                    <button class="btn-cancel" @onclick="CancelAbandon">Cancel</button>
                    <button class="btn-confirm" @onclick="ExecuteAbandon">Confirm Abandon</button>
                </div>
            </div>
        </div>
    }

    <!-- Quick Navigation -->
    <div class="management-options">
        <button @onclick="NavigateToBuildings">Buildings</button>
        <button @onclick="NavigateToTechnology">Research</button>
        <button @onclick="NavigateToFleet">Fleet</button>
        <button @onclick="NavigateToDefense">Defense</button>
        <button @onclick="NavigateToFactory">Factory</button>
        <button @onclick="NavigateToConstellation">Galaxy</button>
    </div>
</div>

@code {
    private System.Threading.Timer? _timer;

    private async void RefreshState()
    {
        await InvokeAsync(StateHasChanged);
    }

    protected override void OnInitialized()
    {
        // Subscribe to all services to get updates when queues change state
        ResourceService.OnChange += RefreshState;
        BuildingService.OnChange += RefreshState;
        TechnologyService.OnChange += RefreshState;
        FleetService.OnChange += RefreshState;
        DefenseService.OnChange += RefreshState;

        // Timer to tick every second for smooth countdowns
        _timer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(StateHasChanged);
        }, null, 0, 1000);
    }

    public void Dispose()
    {
        ResourceService.OnChange -= RefreshState;
        BuildingService.OnChange -= RefreshState;
        TechnologyService.OnChange -= RefreshState;
        FleetService.OnChange -= RefreshState;
        DefenseService.OnChange -= RefreshState;
        _timer?.Dispose();
    }

    // Helper to sort missions by immediate relevant time
    private IEnumerable<FleetMission> GetSortedMissions()
    {
        // Snapshot to avoid modification errors
        var list = FleetService.ActiveFleets.ToList(); 
        
        return list.OrderBy(m => 
            m.Status == FleetStatus.Return ? m.ReturnTime : m.ArrivalTime
        );
    }

    private string GetMissionTime(FleetMission mission)
    {
        var targetTime = mission.Status == FleetStatus.Return ? mission.ReturnTime : mission.ArrivalTime;
        var diff = targetTime - DateTime.Now;
        
        if (diff.TotalSeconds < 0) return "Arrived";
        
        return diff.ToString(@"hh\:mm\:ss");
    }

    // Planet Navigation
    private void NavigateToPlanet(GalaxyPlanet planet)
    {
        // Logic to switch active planet (if we had multi-planet context switching)
        // For now, just maybe show a toast or stay on page
        // In a real app, this would set the 'CurrentPlanetId' in a session service
    }

    // Abandon Logic
    private bool ShowAbandonConfirmation = false;
    private GalaxyPlanet? PlanetToAbandon;

    private void ConfirmAbandon(GalaxyPlanet planet)
    {
        PlanetToAbandon = planet;
        ShowAbandonConfirmation = true;
    }

    private void CancelAbandon()
    {
        ShowAbandonConfirmation = false;
        PlanetToAbandon = null;
    }

    private void ExecuteAbandon()
    {
        if (PlanetToAbandon != null)
        {
            GalaxyService.AbandonPlanet(PlanetToAbandon);
        }
        CancelAbandon();
        StateHasChanged();
    }

    // Navigation Helpers
    private void NavigateToBuildings() => Navigation.NavigateTo("/buildings");
    private void NavigateToTechnology() => Navigation.NavigateTo("/technologies");
    private void NavigateToFleet() => Navigation.NavigateTo("/fleet");
    private void NavigateToDefense() => Navigation.NavigateTo("/defense");
    private void NavigateToFactory() => Navigation.NavigateTo("/factory");
    private void NavigateToConstellation() => Navigation.NavigateTo("/constellation");
}
