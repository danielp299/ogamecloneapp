
@page "/"
@using Microsoft.AspNetCore.Components
@using myapp.Services
@inject NavigationManager Navigation
@inject ResourceService ResourceService
@inject BuildingService BuildingService
@inject GalaxyService GalaxyService
@implements IDisposable

<PageTitle>Home</PageTitle>

<style>

    body {
        font-family: sans-serif;
        margin: 0;
        padding: 0;
        background-color: #111;
        color: #eee;
    }

    .home-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .banner {
        background-color: #222;
        padding: 20px;
        text-align: center;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .resource-bar {
        display: flex;
        justify-content: space-around;
        background-color: #333;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .resource {
        text-align: center;
    }

    .resource img {
        width: 32px;
        height: 32px;
    }

    .main-content {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .planet-info, .construction-queue, .active-events {
        background-color: #222;
        padding: 20px;
        border-radius: 10px;
        flex: 1;
    }

    .planet-card {
        background-color: #333;
        padding: 20px;
        border-radius: 5px;
        text-align: center;
    }

    .queue-grid, .events-list {
        display: grid;
        gap: 10px;
    }

    .queue-item, .event-item {
        background-color: #333;
        padding: 10px;
        border-radius: 5px;
    }

    .other-planets {
        margin-bottom: 20px;
    }

    .planets-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
    }
    
    .planet-card img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
    }

    .management-options {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .management-options button {
        background-color: #333;
        color: #eee;
        border: 1px solid #555;
        padding: 15px 30px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1.1em;
        transition: background-color 0.2s;
    }

    .management-options button:hover {
        background-color: #555;
    }

    .planet-card-wrapper {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .btn-abandon {
        background-color: #800;
        color: #fff;
        border: none;
        padding: 5px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.8em;
    }

    .btn-abandon:hover {
        background-color: #a00;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background-color: #222;
        padding: 20px;
        border-radius: 10px;
        border: 1px solid #555;
        max-width: 400px;
        text-align: center;
        color: white;
    }

    .warning-text {
        color: #ff6666;
        font-size: 0.9em;
        margin: 15px 0;
    }

    .modal-actions {
        display: flex;
        justify-content: space-around;
        gap: 10px;
        margin-top: 20px;
    }

    .btn-cancel {
        background-color: #555;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
    }

    .btn-confirm {
        background-color: #d00;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
    }
</style>

<div class="home-container">
    <!-- OGame Banner -->
    <div class="banner">
        <h1>Ogame Banner</h1>
    </div>

    <!-- Resource Bar Removed (Now in MainLayout) -->

    <!-- Main Content -->
    <div class="main-content">
        <!-- Planet Info -->
        <div class="planet-info">
            <h2>Planet Info</h2>
            <div class="planet-card">
                <img src="planet.jpg" alt="Planet" />
                <p>Name: @PlanetName</p>
                <p>Size: @PlanetSize fields</p>
                <p>Temperature: @PlanetTemperature°C</p>
                <p>Construction Fields: @UsedFields / @MaxFields</p>
            </div>
        </div>

        <!-- Construction Queue -->
        <div class="construction-queue">
            <h2>Construction Queue</h2>
            @if (ConstructionQueue.Count > 0)
            {
                <div class="queue-grid">
                    @foreach (var item in ConstructionQueue)
                    {
                        <div class="queue-item">
                            <p>@item.Title</p>
                            <p>Time: @item.RemainingTime.ToString(@"hh\:mm\:ss")</p>
                            <button @onclick="() => CancelItem(item)">Cancel</button>
                        </div>
                    }
                </div>
            }
            else
            {
                <p>No items in queue.</p>
            }
        </div>

        <!-- Active Events -->
        <div class="active-events">
            <h2>Active Events</h2>
            @if (ActiveEvents.Count > 0)
            {
                <div class="events-list">
            @foreach (var ev in ActiveEvents)
            {
                <div class="event-item">
                    <p>@ev.Description</p>
                    <p>Arrival: @ev.ArrivalTime.ToString("HH:mm:ss")</p>
                </div>
            }
                </div>
            }
            else
            {
                <p>No active events.</p>
            }
        </div>
    </div>

    <!-- Other Planets -->
    <div class="other-planets">
        <h2>Your Planets</h2>
        <div class="planets-grid">
            @foreach (var planet in GalaxyService.PlayerPlanets)
            {
                <div class="planet-card-wrapper">
                    <div class="planet-card" @onclick="() => NavigateToPlanet(planet)">
                        <img src="@planet.Image" alt="@planet.Name" />
                        <p>@planet.Name</p>
                        <p>[@planet.Galaxy:@planet.System:@planet.Position]</p>
                        <p>Temp: @GetTemperature(planet.Position)°C</p>
                    </div>
                    @if (!planet.IsHomeworld)
                    {
                        <button class="btn-abandon" @onclick="() => ConfirmAbandon(planet)">Abandon</button>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Abandon Confirmation Modal -->
    @if (ShowAbandonConfirmation)
    {
        <div class="modal-overlay">
            <div class="modal-content">
                <h3>Abandon Colony</h3>
                <p>Are you sure you want to abandon <strong>@PlanetToAbandon?.Name</strong>?</p>
                <p class="warning-text">This action cannot be undone. All buildings and resources on this planet will be lost forever.</p>
                <div class="modal-actions">
                    <button class="btn-cancel" @onclick="CancelAbandon">Cancel</button>
                    <button class="btn-confirm" @onclick="ExecuteAbandon">Confirm Abandon</button>
                </div>
            </div>
        </div>
    }

    <!-- Management Options -->
    <div class="management-options">
        <button @onclick="NavigateToBuildings">Buildings</button>
        <button @onclick="NavigateToTechnology">Technology</button>
        <button @onclick="NavigateToFleet">Fleet</button>
        <button @onclick="NavigateToDefense">Defense</button>
        <button @onclick="NavigateToFactory">Factory</button>
        <button @onclick="NavigateToConstellation">Constellation</button>
    </div>
</div>


@code {
    // Resource Data
    // Metal, Crystal, Deuterium come from ResourceService now
    private long MetalCapacity = 100000;
    private long MetalProduction = 500;

    private long CrystalCapacity = 50000;
    private long CrystalProduction = 250;

    private long DeuteriumCapacity = 20000;
    private long DeuteriumProduction = 100;

    private long Energy = 150;

    // Planet Data
    private string PlanetName = "Home Planet";
    private int PlanetSize = 100;
    private int PlanetTemperature = 20;
    private int UsedFields = 15;
    private int MaxFields = 163;

    // Construction Queue
    private List<QueueItem> ConstructionQueue = new();

    // Active Events
    private List<EventItem> ActiveEvents = new();

    protected override void OnInitialized()
    {
        ResourceService.OnChange += RefreshState;
        
        // Ensure resources are up to date when page loads
        BuildingService.UpdateProduction();

        // Initialize queue with examples
        if(ConstructionQueue.Count == 0) {
             ConstructionQueue.Add(new QueueItem { Title = "Metal Mine", RemainingTime = TimeSpan.FromMinutes(30) });
             ConstructionQueue.Add(new QueueItem { Title = "Research Lab", RemainingTime = TimeSpan.FromHours(1) });
        }

        // Initialize events
        if(ActiveEvents.Count == 0) {
            ActiveEvents.Add(new EventItem { Description = "Fleet returning from attack", ArrivalTime = DateTime.Now.AddMinutes(15) });
        }
    }

    private async void RefreshState()
    {
        await InvokeAsync(StateHasChanged);
    }

    private int GetTemperature(int position)
    {
         // Simple approximation based on position
         return 30 - (position * 2);
    }

    public void Dispose()
    {
        ResourceService.OnChange -= RefreshState;
    }

    private void CancelItem(QueueItem item)
    {
        ConstructionQueue.Remove(item);
    }

    private void NavigateToPlanet(GalaxyPlanet planet)
    {
        // Placeholder navigation
    }

    // Abandon Logic
    private bool ShowAbandonConfirmation = false;
    private GalaxyPlanet? PlanetToAbandon;

    private void ConfirmAbandon(GalaxyPlanet planet)
    {
        PlanetToAbandon = planet;
        ShowAbandonConfirmation = true;
    }

    private void CancelAbandon()
    {
        ShowAbandonConfirmation = false;
        PlanetToAbandon = null;
    }

    private void ExecuteAbandon()
    {
        if (PlanetToAbandon != null)
        {
            GalaxyService.AbandonPlanet(PlanetToAbandon);
        }
        CancelAbandon();
        StateHasChanged();
    }

    private void NavigateToBuildings()
    {
        Navigation.NavigateTo("/buildings");
    }

    private void NavigateToTechnology()
    {
        Navigation.NavigateTo("/technologies");
    }

    private void NavigateToFleet()
    {
        Navigation.NavigateTo("/fleet");
    }

    private void NavigateToDefense()
    {
        Navigation.NavigateTo("/defense");
    }

    private void NavigateToFactory()
    {
        Navigation.NavigateTo("/factory");
    }

    private void NavigateToConstellation()
    {
        Navigation.NavigateTo("/constellation");
    }

    public class QueueItem
    {
        public string Title { get; set; } = "";
        public TimeSpan RemainingTime { get; set; }
    }

    public class EventItem
    {
        public string Description { get; set; } = "";
        public DateTime ArrivalTime { get; set; }
    }
}


