
@page "/"
@using Microsoft.AspNetCore.Components
@using myapp.Services
@inject NavigationManager Navigation
@inject ResourceService ResourceService
@inject BuildingService BuildingService
@implements IDisposable

<PageTitle>Home</PageTitle>

<style>

    body {
        font-family: sans-serif;
        margin: 0;
        padding: 0;
        background-color: #111;
        color: #eee;
    }

    .home-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .banner {
        background-color: #222;
        padding: 20px;
        text-align: center;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .resource-bar {
        display: flex;
        justify-content: space-around;
        background-color: #333;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .resource {
        text-align: center;
    }

    .resource img {
        width: 32px;
        height: 32px;
    }

    .main-content {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .planet-info, .construction-queue, .active-events {
        background-color: #222;
        padding: 20px;
        border-radius: 10px;
        flex: 1;
    }

    .planet-card {
        background-color: #333;
        padding: 20px;
        border-radius: 5px;
        text-align: center;
    }

    .queue-grid, .events-list {
        display: grid;
        gap: 10px;
    }

    .queue-item, .event-item {
        background-color: #333;
        padding: 10px;
        border-radius: 5px;
    }

    .other-planets {
        margin-bottom: 20px;
    }

    .planets-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
    }
    
    .planet-card img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
    }

    .management-options {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .management-options button {
        background-color: #333;
        color: #eee;
        border: 1px solid #555;
        padding: 15px 30px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1.1em;
        transition: background-color 0.2s;
    }

    .management-options button:hover {
        background-color: #555;
    }
</style>

<div class="home-container">
    <!-- OGame Banner -->
    <div class="banner">
        <h1>Ogame Banner</h1>
    </div>

    <!-- Resource Bar Removed (Now in MainLayout) -->

    <!-- Main Content -->
    <div class="main-content">
        <!-- Planet Info -->
        <div class="planet-info">
            <h2>Planet Info</h2>
            <div class="planet-card">
                <img src="planet.jpg" alt="Planet" />
                <p>Name: @PlanetName</p>
                <p>Size: @PlanetSize fields</p>
                <p>Temperature: @PlanetTemperature°C</p>
                <p>Construction Fields: @UsedFields / @MaxFields</p>
            </div>
        </div>

        <!-- Construction Queue -->
        <div class="construction-queue">
            <h2>Construction Queue</h2>
            @if (ConstructionQueue.Count > 0)
            {
                <div class="queue-grid">
                    @foreach (var item in ConstructionQueue)
                    {
                        <div class="queue-item">
                            <p>@item.Title</p>
                            <p>Time: @item.RemainingTime.ToString(@"hh\:mm\:ss")</p>
                            <button @onclick="() => CancelItem(item)">Cancel</button>
                        </div>
                    }
                </div>
            }
            else
            {
                <p>No items in queue.</p>
            }
        </div>

        <!-- Active Events -->
        <div class="active-events">
            <h2>Active Events</h2>
            @if (ActiveEvents.Count > 0)
            {
                <div class="events-list">
            @foreach (var ev in ActiveEvents)
            {
                <div class="event-item">
                    <p>@ev.Description</p>
                    <p>Arrival: @ev.ArrivalTime.ToString("HH:mm:ss")</p>
                </div>
            }
                </div>
            }
            else
            {
                <p>No active events.</p>
            }
        </div>
    </div>

    <!-- Other Planets -->
    <div class="other-planets">
        <h2>Other Planets</h2>
        <div class="planets-grid">
            @for (int i = 1; i <= Planets.Count; i++)
            {
                var planet = Planets[i - 1];
                <div class="planet-card" @onclick="() => NavigateToPlanet(planet)">
                    <img src="planet.jpg" alt="Planet @i" />
                    <p>@planet.Name</p>
                    <p>[@planet.Coordinates]</p>
                    <p>Temp: @planet.Temperature°C</p>
                </div>
            }
        </div>
    </div>

    <!-- Management Options -->
    <div class="management-options">
        <button @onclick="NavigateToBuildings">Buildings</button>
        <button @onclick="NavigateToTechnology">Technology</button>
        <button @onclick="NavigateToFleet">Fleet</button>
        <button @onclick="NavigateToDefense">Defense</button>
        <button @onclick="NavigateToFactory">Factory</button>
        <button @onclick="NavigateToConstellation">Constellation</button>
    </div>
</div>


@code {
    // Resource Data
    // Metal, Crystal, Deuterium come from ResourceService now
    private long MetalCapacity = 100000;
    private long MetalProduction = 500;

    private long CrystalCapacity = 50000;
    private long CrystalProduction = 250;

    private long DeuteriumCapacity = 20000;
    private long DeuteriumProduction = 100;

    private long Energy = 150;

    // Planet Data
    private string PlanetName = "Home Planet";
    private int PlanetSize = 100;
    private int PlanetTemperature = 20;
    private int UsedFields = 15;
    private int MaxFields = 163;

    // Construction Queue
    private List<QueueItem> ConstructionQueue = new();

    // Active Events
    private List<EventItem> ActiveEvents = new();

    // Planets
    private List<Planet> Planets = new();

    protected override void OnInitialized()
    {
        ResourceService.OnChange += RefreshState;
        
        // Ensure resources are up to date when page loads
        BuildingService.UpdateProduction();

        // Initialize planets
        for (int i = 1; i <= 8; i++)
        {
            Planets.Add(new Planet
            {
                Name = $"Planet {i}",
                Coordinates = $"1:{i}:1",
                Temperature = 20 + i
            });
        }

        // Initialize queue with examples
        if(ConstructionQueue.Count == 0) {
             ConstructionQueue.Add(new QueueItem { Title = "Metal Mine", RemainingTime = TimeSpan.FromMinutes(30) });
             ConstructionQueue.Add(new QueueItem { Title = "Research Lab", RemainingTime = TimeSpan.FromHours(1) });
        }

        // Initialize events
        if(ActiveEvents.Count == 0) {
            ActiveEvents.Add(new EventItem { Description = "Fleet returning from attack", ArrivalTime = DateTime.Now.AddMinutes(15) });
        }
    }

    private async void RefreshState()
    {
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        ResourceService.OnChange -= RefreshState;
    }

    private void CancelItem(QueueItem item)
    {
        ConstructionQueue.Remove(item);
    }

    private void NavigateToPlanet(Planet planet)
    {
        // Placeholder navigation
    }

    private void NavigateToBuildings()
    {
        Navigation.NavigateTo("/buildings");
    }

    private void NavigateToTechnology()
    {
        Navigation.NavigateTo("/technologies");
    }

    private void NavigateToFleet()
    {
        Navigation.NavigateTo("/fleet");
    }

    private void NavigateToDefense()
    {
        Navigation.NavigateTo("/defense");
    }

    private void NavigateToFactory()
    {
        Navigation.NavigateTo("/factory");
    }

    private void NavigateToConstellation()
    {
        Navigation.NavigateTo("/constellation");
    }

    public class QueueItem
    {
        public string Title { get; set; } = "";
        public TimeSpan RemainingTime { get; set; }
    }

    public class EventItem
    {
        public string Description { get; set; } = "";
        public DateTime ArrivalTime { get; set; }
    }

    public class Planet
    {
        public string Name { get; set; } = "";
        public string Coordinates { get; set; } = "";
        public int Temperature { get; set; }
    }
}


